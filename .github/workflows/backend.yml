name: Backend CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths: ["backend-disc/**"]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      API_SECRET_KEY: ${{ secrets.API_SECRET_KEY }}

    steps:
      - uses: actions/checkout@v4

      # -----------------------
      # SQL Server Startup
      # -----------------------
      - name: Start SQL Server
        shell: bash
        run: |
          docker run \
            -e ACCEPT_EULA=Y \
            -e SA_PASSWORD="$DB_PASSWORD" \
            -p 1433:1433 \
            --name disc-mssql \
            -d mcr.microsoft.com/mssql/server:2022-latest

          echo "Waiting for SQL Server..."
          for i in {1..60}; do
            if docker logs disc-mssql 2>&1 | grep -q "SQL Server is now ready"; then
              echo "SQL Server ready!"
              break
            fi
            sleep 2
          done

      # -----------------------
      # Setup .NET
      # -----------------------
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "8.0.x"

      - name: Restore dependencies
        working-directory: backend-disc
        run: dotnet restore

      - name: Build API
        working-directory: backend-disc
        run: dotnet build --no-restore --configuration Release

      # -----------------------
      # Start API
      # -----------------------
      - name: Start API
        working-directory: backend-disc
        env:
          ConnectionStrings__DefaultConnection: "Server=localhost,1433;Database=${{ secrets.DB_NAME }};User Id=sa;Password=${{ secrets.DB_PASSWORD }};TrustServerCertificate=True;"
          API_SECRET_KEY: ${{ secrets.API_SECRET_KEY }}
          ASPNETCORE_URLS: http://0.0.0.0:5000
          ASPNETCORE_ENVIRONMENT: Development
        run: |
          # start API in background, capture stdout/stderr to api.log and save PID
          dotnet run --project backend-disc/backend-disc.csproj --configuration Release --urls "http://0.0.0.0:5000" > api.log 2>&1 &
          echo $! > api.pid
          sleep 2
          # give it some more time to warm up
          sleep 10

      - name: Check if API is listening
        run: |
          echo "Checking port 5000..."
          sudo lsof -i -P -n | grep LISTEN || echo "❌ API is NOT listening!"
          curl -v http://localhost:5000 || echo "❌ curl could not reach the API"

      - name: Show API logs
        if: always()
        run: |
          echo "----- API LOG -----"
          cat api.log || echo "api.log missing"

      # -----------------------
      # Run Postman Tests
      # -----------------------
      - name: Install Newman
        run: npm install -g newman

      - name: Run Postman tests
        working-directory: backend-disc
        run: |
          newman run Disc-api-test.postman_collection.json \
            --environment postman-env.json \
            --reporters cli,json \
            --reporter-json-export test-results.json

      - name: Upload Postman results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: postman-results
          path: backend-disc/test-results.json
